#!/usr/bin/env bash

set -e

ROOT=`git rev-parse --show-toplevel`
export GOPATH=$ROOT/osc-bridge/

EXTERNAL_IP=$(curl -s "http://metadata.google.internal/computeMetadata/v1/instance/network-interfaces/0/access-configs/0/external-ip" -H "Metadata-Flavor: Google")
INTERNAL_IP=$(curl -s "http://metadata.google.internal/computeMetadata/v1/instance/network-interfaces/0/ip" -H "Metadata-Flavor: Google")

echo "Generating GCE JavaScript config file..."
# Generating a default configuration is necessary for the Figwheel
# server to provide a valid configuration.
mkdir -p sonic-jam/resources/public/config
go run $GOPATH/src/sonicjam/generate/generate.go \
   --js_output_file $ROOT/sonic-jam/resources/public/config/config.js \
   --ui_ip ${INTERNAL_IP} \
   --ui_external_ip ${EXTERNAL_IP}

echo "Starting figwheel..."
( cd sonic-jam; $ROOT/bin/vendor/lein figwheel )
