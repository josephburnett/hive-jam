#!/usr/bin/env bash

set -e

ROOT=`git rev-parse --show-toplevel`
export GOPATH=$ROOT/osc-bridge/
PATH=$GOPATH/bin:$PATH

cd $ROOT

echo "Compiling UI..."
( cd sonic-jam ; $ROOT/bin/vendor/lein cljsbuild once min )

echo "Setting up Golang dependencies and go-bindata tool..."
go get github.com/tools/godep
( cd $GOPATH; godep restore )
go install github.com/jteeuwen/go-bindata/...

echo "Generating default JavaScript config file..."
go run $GOPATH/src/sonicjam/generate/generate.go \
   --js_output_file $ROOT/sonic-jam/resources/public/config/config.js

echo "Packaging UI and Sonic Pi server files as data..."
mkdir -p osc-bridge/data
go-bindata -o osc-bridge/src/sonicjam/data/data.go -pkg data \
	   sonic-pi/... \
	   sonic-jam/resources/public/...

echo "Building the Sonic Jam binary..."
mkdir -p build
go build -o $ROOT/build/sonic-jam \
    $GOPATH/src/sonicjam/server/server.go

echo "Done."
echo "Start Sonic Pi and then run ./build/sonic-jam"

